# ADR-001: 아키텍처 분리 원칙 (LLM 격리)

## 상태
Accepted

## 날짜
2025-01-XX

## 컨텍스트
rKYC 시스템은 금융기관 기업심사를 위한 AI 기반 리스크 분석 시스템이다.
LLM(Large Language Model)을 활용하여 시그널을 추출하고 인사이트를 생성하는데,
이 과정에서 보안, 비용, 성능 측면의 고려가 필요하다.

### 고려 사항
1. LLM API 키는 민감한 자격 증명으로, 노출 시 비용 및 보안 문제 발생
2. LLM 호출은 비용이 높고 응답 시간이 길어 사용자 경험에 영향
3. 프론트엔드는 공개 환경(브라우저)에서 실행되어 보안 취약
4. 분석 작업은 장시간 소요될 수 있어 비동기 처리 필요

## 결정
**3-tier 아키텍처를 채택하고, LLM 호출을 Worker 레이어에 격리한다.**

```
Frontend (Vercel)     →  Backend API (FastAPI)  →  Worker (Celery)
- No LLM Key             - No LLM Key              - LLM Keys
- No DB                  - DB Access               - DB Access
- UI/UX Only             - CRUD Only               - AI Processing
```

### 물리적 제약
| 컴포넌트 | LLM 키 | DB 접근 | 역할 |
|---------|--------|---------|------|
| Frontend | ❌ | ❌ | UI 렌더링, 사용자 인터랙션 |
| Backend API | ❌ | ✅ | REST API, 데이터 CRUD |
| Worker | ✅ | ✅ | LLM 호출, 분석 파이프라인 |

## 결과

### 긍정적 결과
1. **보안 강화**: LLM 키가 Worker에만 존재하여 노출 위험 최소화
2. **비용 제어**: LLM 호출이 Worker에 집중되어 모니터링/제한 용이
3. **확장성**: Worker 스케일 아웃으로 분석 처리량 독립적 확장 가능
4. **사용자 경험**: 프론트엔드가 LLM 응답 대기 없이 즉시 반응
5. **장애 격리**: Worker 장애가 API 서버에 영향 미치지 않음

### 부정적 결과
1. **복잡성 증가**: 3개 레이어 간 통신 로직 필요
2. **지연 시간**: 분석 결과 확인까지 폴링/웹소켓 필요
3. **운영 부담**: 3개 서비스 각각 모니터링/배포 필요

### 리스크 및 완화
- **Worker 장애**: 작업 큐(Redis)가 작업 보존, 재시작 시 재처리
- **DB 연결 이슈**: Connection pooling (pgbouncer) 적용
- **LLM 장애**: Fallback 체인 (ADR-002 참조)

## 대안 검토

### 대안 1: 모놀리식 (Backend에서 LLM 직접 호출)
- 장점: 구조 단순, 배포 용이
- 단점: API 응답 지연, 스케일링 어려움, 키 노출 위험
- **기각 사유**: 장시간 LLM 호출이 API 서버 블로킹

### 대안 2: 서버리스 (Lambda/Cloud Functions)
- 장점: 자동 스케일링, 관리 부담 감소
- 단점: Cold start 지연, 실행 시간 제한 (15분), 상태 관리 어려움
- **기각 사유**: 파이프라인 8단계가 15분 초과 가능

### 대안 3: Frontend에서 LLM 직접 호출
- 장점: 실시간 스트리밍 가능
- 단점: API 키 노출, 비용 통제 불가, 보안 취약
- **기각 사유**: 금융 시스템에서 허용 불가한 보안 리스크

## 참조
- PRD Full-Stack Spec v0.2 - Section 2.1 아키텍처 개요
- PRD 추가 지침서 - 물리적 제약 조건
