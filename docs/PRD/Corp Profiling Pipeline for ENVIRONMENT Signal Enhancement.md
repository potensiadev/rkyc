PRD: Corp Profiling Pipeline for ENVIRONMENT Signal Enhancement

  ---                                                                                                             📋 Document Control
  ┌─────────┬──────────────────────────┐                                                                        
  │  항목   │           내용           │
  ├─────────┼──────────────────────────┤
  │ 문서 ID │ PRD-2026-001             │
  ├─────────┼──────────────────────────┤
  │ 버전    │ v1.0 (Final)             │
  ├─────────┼──────────────────────────┤
  │ 작성자  │ Senior Product Manager   │
  ├─────────┼──────────────────────────┤
  │ 작성일  │ 2026-01-19               │
  ├─────────┼──────────────────────────┤
  │ 검토자  │ Senior Engineer, QA Lead │
  ├─────────┼──────────────────────────┤
  │ 승인일  │ 2026-01-19               │
  └─────────┴──────────────────────────┘
  ---
  Part 1: Initial PRD Draft (PM 작성)

  1. 개요 (Overview)

  1.1 배경

  현재 rKYC 시스템의 ENVIRONMENT 시그널 생성 파이프라인은 corp_name과 industry_code만을 기반으로 외부
  검색(Perplexity)을 수행한다. 이로 인해:

  1. 기업의 실제 사업 특성(수출 비중, 국가별 노출, 원자재 의존도 등)을 모른 채 검색
  2. 15개 ENVIRONMENT 리스크 카테고리 중 대부분 활성화 불가
  3. Grounding 없는 검색으로 Hallucination 위험 높음

  1.2 솔루션

  Corp Profiling Pipeline 도입: 기업명으로 먼저 기업 정보를 수집하고 구조화한 후, 해당 프로파일을 기반으로      
  조건부 ENVIRONMENT 쿼리를 실행한다.

  1.3 목표

  - ENVIRONMENT 시그널의 Grounding 정확도 향상
  - 15개 리스크 카테고리 중 12개 이상 활성화
  - Hallucination 기반 시그널 생성 비율 < 10%

  ---
  2. 문제 정의 (Problem Statement)

  2.1 현재 상태 (AS-IS)

  ┌─────────────┐     ┌─────────────────────┐     ┌─────────────┐
  │ corp_name   │────▶│ Perplexity 뉴스검색  │────▶│ Signal 생성  │
  │ industry    │     │ (맹목적 검색)        │     │ (Grounding X)│
  └─────────────┘     └─────────────────────┘     └─────────────┘

  문제점:
  ┌──────────────────┬────────────────────────────────────────────────────┐
  │       문제       │                        영향                        │
  ├──────────────────┼────────────────────────────────────────────────────┤
  │ 기업 특성 미파악 │ "중국 리스크" 검색 시 해당 기업의 중국 노출도 모름 │
  ├──────────────────┼────────────────────────────────────────────────────┤
  │ 일괄 쿼리 실행   │ 관련 없는 리스크까지 검색 → 노이즈 증가            │
  ├──────────────────┼────────────────────────────────────────────────────┤
  │ Evidence 부재    │ "수출 비중 40%"라는 근거 없이 환율 리스크 판단     │
  └──────────────────┴────────────────────────────────────────────────────┘
  2.2 목표 상태 (TO-BE)

  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
  │ corp_name   │────▶│ Corp        │────▶│ 조건부 쿼리  │────▶│ Signal 생성  │
  │ industry    │     │ Profiling   │     │ 선택/실행    │     │ (Grounding O)│
  └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                            │
                            ▼
                      ┌─────────────┐
                      │ Profile DB  │
                      │ 저장/캐싱    │
                      └─────────────┘

  ---
  3. 사용자 스토리 (User Stories)

  US-01: 기업심사 담당자

  "특정 기업의 ENVIRONMENT 리스크를 검토할 때, 해당 기업이 실제로 어떤 국가에 노출되어 있고, 어떤 원자재에      
  의존하는지 근거와 함께 확인하고 싶다."

  인수 조건:
  - 시그널에 기업 프로파일 정보가 Evidence로 포함됨
  - "수출 비중 60%, 중국 매출 20%"와 같은 정량 근거 표시
  - 근거 출처(Perplexity 검색 결과 URL) 제공

  US-02: 리스크 관리자

  "ENVIRONMENT 시그널이 해당 기업과 실제로 관련 있는지 신뢰할 수 있어야 한다. 업종 일반론이 아닌 기업 특정      
  리스크를 보고 싶다."

  인수 조건:
  - 프로파일 기반 조건부 쿼리로 관련성 높은 시그널만 생성
  - 시그널 confidence에 프로파일 신뢰도 반영

  ---
  4. 기능 요구사항 (Functional Requirements)

  FR-01: Corp Profiling 실행
  ┌─────────┬──────────────────────────────────────────────────┬──────────┐
  │   ID    │                     요구사항                     │ 우선순위 │
  ├─────────┼──────────────────────────────────────────────────┼──────────┤
  │ FR-01-1 │ corp_name + industry_code로 Perplexity 검색 실행 │ P0       │
  ├─────────┼──────────────────────────────────────────────────┼──────────┤
  │ FR-01-2 │ 검색 결과를 LLM으로 구조화된 Profile JSON 추출   │ P0       │
  ├─────────┼──────────────────────────────────────────────────┼──────────┤
  │ FR-01-3 │ Profile을 DB에 저장 (캐싱 목적)                  │ P1       │
  ├─────────┼──────────────────────────────────────────────────┼──────────┤
  │ FR-01-4 │ 기존 Profile이 있으면 TTL 체크 후 재사용         │ P1       │
  └─────────┴──────────────────────────────────────────────────┴──────────┘
  FR-02: Profile 데이터 구조
  ┌─────────────────────┬─────────────┬────────────────────────┬──────┐
  │        필드         │    타입     │          설명          │ 필수 │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ corp_id             │ VARCHAR(20) │ 기업 ID                │ Y    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ business_summary    │ TEXT        │ 주요 사업 요약 (100자) │ Y    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ revenue_krw         │ BIGINT      │ 연 매출 (원화)         │ N    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ export_ratio_pct    │ INTEGER     │ 수출 비중 (%)          │ N    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ country_exposure    │ JSONB       │ 국가별 노출 비중       │ N    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ key_materials       │ TEXT[]      │ 주요 원자재 목록       │ N    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ key_customers       │ TEXT[]      │ 주요 고객사 목록       │ N    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ overseas_operations │ TEXT[]      │ 해외 법인/공장         │ N    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ profile_confidence  │ ENUM        │ HIGH/MED/LOW           │ Y    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ source_urls         │ TEXT[]      │ 출처 URL 목록          │ Y    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ fetched_at          │ TIMESTAMPTZ │ 수집 시점              │ Y    │
  ├─────────────────────┼─────────────┼────────────────────────┼──────┤
  │ expires_at          │ TIMESTAMPTZ │ 만료 시점 (TTL)        │ Y    │
  └─────────────────────┴─────────────┴────────────────────────┴──────┘
  FR-03: 조건부 ENVIRONMENT 쿼리 선택
  ┌──────────────────────────────────┬──────────────────────────────────────────────────────┐
  │               조건               │               활성화되는 쿼리 카테고리               │
  ├──────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ export_ratio_pct >= 30           │ FX_RISK, TRADE_BLOC                                  │
  ├──────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ "중국" in country_exposure       │ GEOPOLITICAL, SUPPLY_CHAIN, REGULATION               │
  ├──────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ "미국" in country_exposure       │ GEOPOLITICAL, REGULATION, TRADE_BLOC                 │
  ├──────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ key_materials is not empty       │ COMMODITY, SUPPLY_CHAIN                              │
  ├──────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ overseas_operations is not empty │ GEOPOLITICAL, PANDEMIC_HEALTH, POLITICAL_INSTABILITY │
  ├──────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ industry_code in ["C26", "C21"]  │ CYBER_TECH                                           │
  ├──────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ industry_code = "D35"            │ ENERGY_SECURITY                                      │
  ├──────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ industry_code = "C10"            │ FOOD_SECURITY                                        │
  └──────────────────────────────────┴──────────────────────────────────────────────────────┘
  FR-04: Evidence 생성
  ┌─────────┬──────────────────────────────────────────────────────────────┬──────────┐
  │   ID    │                           요구사항                           │ 우선순위 │
  ├─────────┼──────────────────────────────────────────────────────────────┼──────────┤
  │ FR-04-1 │ Profile 정보를 Signal의 Evidence로 연결                      │ P0       │
  ├─────────┼──────────────────────────────────────────────────────────────┼──────────┤
  │ FR-04-2 │ evidence_type = CORP_PROFILE 신규 추가                       │ P0       │
  ├─────────┼──────────────────────────────────────────────────────────────┼──────────┤
  │ FR-04-3 │ ref_value에 Profile 필드 경로 저장 (e.g., /export_ratio_pct) │ P0       │
  └─────────┴──────────────────────────────────────────────────────────────┴──────────┘
  ---
  5. 기술 요구사항 (Technical Requirements)

  TR-01: 신규 파일
  ┌───────────────────────────────┬───────────────────────────────┬─────────────────────────┐
  │             파일              │             위치              │          설명           │
  ├───────────────────────────────┼───────────────────────────────┼─────────────────────────┤
  │ corp_profiling.py             │ backend/app/worker/pipelines/ │ Corp Profiling Pipeline │
  ├───────────────────────────────┼───────────────────────────────┼─────────────────────────┤
  │ profile.py                    │ backend/app/models/           │ SQLAlchemy 모델         │
  ├───────────────────────────────┼───────────────────────────────┼─────────────────────────┤
  │ profile.py                    │ backend/app/schemas/          │ Pydantic 스키마         │
  ├───────────────────────────────┼───────────────────────────────┼─────────────────────────┤
  │ migration_v7_corp_profile.sql │ backend/sql/                  │ DB 마이그레이션         │
  └───────────────────────────────┴───────────────────────────────┴─────────────────────────┘
  TR-02: 파이프라인 통합

  변경 전:
  SNAPSHOT → DOC_INGEST → EXTERNAL → CONTEXT → SIGNAL → ...

  변경 후:
  SNAPSHOT → DOC_INGEST → PROFILING → EXTERNAL → CONTEXT → SIGNAL → ...
                              ↓
                         (Profile 저장)

  TR-03: Perplexity 쿼리 설계

  PROFILING_QUERIES = {
      "BASIC": "{corp_name} 기업 개요 주요 사업 제품",
      "FINANCIAL": "{corp_name} 매출 영업이익 재무 현황 {year}",
      "EXPORT": "{corp_name} 수출 비중 해외 매출 주요 수출국",
      "SUPPLY": "{corp_name} 주요 원자재 공급망 협력사",
      "GLOBAL": "{corp_name} 해외 법인 공장 진출국",
  }

  TR-04: LLM 프롬프트

  PROFILE_EXTRACTION_PROMPT = """
  다음 검색 결과를 바탕으로 {corp_name}의 비즈니스 프로파일을 JSON으로 구조화하세요.

  ## 검색 결과
  {search_results}

  ## 추출 항목
  - business_summary: 주요 사업 내용 (한글, 100자 이내)
  - revenue_krw: 연 매출 (숫자만, 원화 기준, 확인 안 되면 null)
  - export_ratio_pct: 수출 비중 (정수 %, 확인 안 되면 null)
  - country_exposure: 국가별 매출/의존 비중 (예: {"중국": 20, "미국": 30})
  - key_materials: 주요 원자재 목록 (예: ["실리콘 웨이퍼", "PCB"])
  - key_customers: 주요 고객사 목록 (예: ["삼성전자"])
  - overseas_operations: 해외 법인/공장 (예: ["베트남 하노이 공장"])
  - profile_confidence: 정보 신뢰도 (HIGH: 공시/IR 기반, MED: 뉴스 기반, LOW: 추정)

  ## 규칙
  - 확인되지 않은 항목은 반드시 null로 표시
  - 추측하지 말고 검색 결과에 명시된 정보만 추출
  - country_exposure의 합이 100%를 초과해도 됨 (매출과 조달이 섞일 수 있음)

  ## 출력 형식
  JSON만 출력하세요.
  """

  ---
  6. 데이터베이스 스키마

  6.1 신규 테이블: rkyc_corp_profile

  CREATE TABLE rkyc_corp_profile (
      profile_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      corp_id VARCHAR(20) NOT NULL REFERENCES corp(corp_id),

      -- 비즈니스 정보
      business_summary TEXT NOT NULL,
      revenue_krw BIGINT,
      export_ratio_pct INTEGER CHECK (export_ratio_pct >= 0 AND export_ratio_pct <= 100),

      -- 노출도 정보
      country_exposure JSONB DEFAULT '{}',
      key_materials TEXT[] DEFAULT '{}',
      key_customers TEXT[] DEFAULT '{}',
      overseas_operations TEXT[] DEFAULT '{}',

      -- 메타데이터
      profile_confidence confidence_level NOT NULL,
      source_urls TEXT[] NOT NULL,
      raw_search_result JSONB,  -- 원본 검색 결과 보관

      -- TTL 관리
      fetched_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      expires_at TIMESTAMPTZ NOT NULL,

      -- 버전 관리
      version INTEGER NOT NULL DEFAULT 1,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      updated_at TIMESTAMPTZ DEFAULT NOW(),

      UNIQUE(corp_id, version)
  );

  -- 최신 프로파일 포인터
  CREATE TABLE rkyc_corp_profile_latest (
      corp_id VARCHAR(20) PRIMARY KEY REFERENCES corp(corp_id),
      profile_id UUID NOT NULL REFERENCES rkyc_corp_profile(profile_id),
      version INTEGER NOT NULL,
      updated_at TIMESTAMPTZ DEFAULT NOW()
  );

  -- 인덱스
  CREATE INDEX idx_profile_corp ON rkyc_corp_profile(corp_id);
  CREATE INDEX idx_profile_expires ON rkyc_corp_profile(expires_at);

  6.2 ENUM 추가

  -- evidence_type_enum에 추가
  ALTER TYPE evidence_type_enum ADD VALUE 'CORP_PROFILE';

  -- ref_type_enum에 추가
  ALTER TYPE ref_type_enum ADD VALUE 'PROFILE_KEYPATH';

  ---
  7. API 스펙

  7.1 신규 엔드포인트
  ┌────────┬────────────────────────────────────────────────┬────────────────────┐
  │ Method │                    Endpoint                    │        설명        │
  ├────────┼────────────────────────────────────────────────┼────────────────────┤
  │ GET    │ /api/v1/corporations/{corp_id}/profile         │ 기업 프로파일 조회 │
  ├────────┼────────────────────────────────────────────────┼────────────────────┤
  │ POST   │ /api/v1/corporations/{corp_id}/profile/refresh │ 프로파일 강제 갱신 │
  └────────┴────────────────────────────────────────────────┴────────────────────┘
  7.2 응답 스키마

  {
    "corp_id": "8001-3719240",
    "business_summary": "반도체 부품 및 전자부품 제조업체",
    "revenue_krw": 50000000000,
    "export_ratio_pct": 60,
    "country_exposure": {
      "미국": 30,
      "중국": 20,
      "베트남": 10
    },
    "key_materials": ["실리콘 웨이퍼", "PCB"],
    "key_customers": ["삼성전자", "SK하이닉스"],
    "overseas_operations": ["베트남 하노이 공장"],
    "profile_confidence": "MED",
    "source_urls": [
      "https://example.com/news/1",
      "https://example.com/news/2"
    ],
    "fetched_at": "2026-01-19T10:00:00Z",
    "expires_at": "2026-01-26T10:00:00Z",
    "is_expired": false
  }

  ---
  8. 비기능 요구사항 (NFR)
  ┌────────┬────────────────────────┬───────────────────────┐
  │   ID   │        요구사항        │        목표값         │
  ├────────┼────────────────────────┼───────────────────────┤
  │ NFR-01 │ Profile 수집 시간      │ < 30초                │
  ├────────┼────────────────────────┼───────────────────────┤
  │ NFR-02 │ Profile TTL            │ 7일 (설정 가능)       │
  ├────────┼────────────────────────┼───────────────────────┤
  │ NFR-03 │ Perplexity API 호출 수 │ 프로파일당 최대 3회   │
  ├────────┼────────────────────────┼───────────────────────┤
  │ NFR-04 │ LLM 비용               │ 프로파일당 < $0.10    │
  ├────────┼────────────────────────┼───────────────────────┤
  │ NFR-05 │ 캐시 히트율            │ > 80% (7일 내 재분석) │
  └────────┴────────────────────────┴───────────────────────┘
  ---
  9. 성공 지표 (Success Metrics)
  ┌────────────────────────────────┬───────────┬───────────┬────────────────────────┐
  │              지표              │   현재    │   목표    │       측정 방법        │
  ├────────────────────────────────┼───────────┼───────────┼────────────────────────┤
  │ ENVIRONMENT 시그널 Grounding율 │ ~20%      │ > 80%     │ Evidence 유무 비율     │
  ├────────────────────────────────┼───────────┼───────────┼────────────────────────┤
  │ 활성화된 리스크 카테고리       │ 2-3개     │ 10개+     │ 조건 충족 카테고리 수  │
  ├────────────────────────────────┼───────────┼───────────┼────────────────────────┤
  │ 시그널 관련성                  │ 측정 불가 │ 측정 가능 │ Profile 기반 조건 매칭 │
  ├────────────────────────────────┼───────────┼───────────┼────────────────────────┤
  │ Hallucination 시그널           │ 추정 높음 │ < 10%     │ Evidence 검증 실패율   │
  └────────────────────────────────┴───────────┴───────────┴────────────────────────┘
  ---
  10. 리스크 및 의존성
  ┌──────┬──────────────────────────────┬───────────────────┬─────────────────────────────────────────────┐     
  │  ID  │            리스크            │       영향        │                  대응 방안                  │     
  ├──────┼──────────────────────────────┼───────────────────┼─────────────────────────────────────────────┤     
  │ R-01 │ Perplexity 검색 결과 부정확  │ Profile 오류      │ confidence 필드로 신뢰도 표시               │     
  ├──────┼──────────────────────────────┼───────────────────┼─────────────────────────────────────────────┤     
  │ R-02 │ 비상장/소규모 기업 정보 부족 │ Profile 생성 실패 │ Graceful degradation (업종 일반론 fallback) │     
  ├──────┼──────────────────────────────┼───────────────────┼─────────────────────────────────────────────┤     
  │ R-03 │ API 비용 증가                │ 운영 비용         │ TTL 캐싱으로 호출 최소화                    │     
  ├──────┼──────────────────────────────┼───────────────────┼─────────────────────────────────────────────┤     
  │ R-04 │ LLM 구조화 실패              │ Profile 파싱 오류 │ 재시도 + 수동 검토 플래그                   │     
  └──────┴──────────────────────────────┴───────────────────┴─────────────────────────────────────────────┘     
  ---
  11. 일정 (Timeline)
  ┌─────────┬─────────────────────────┬───────┐
  │  Phase  │          항목           │ 기간  │
  ├─────────┼─────────────────────────┼───────┤
  │ Phase 1 │ DB 스키마 + 모델        │ 1일   │
  ├─────────┼─────────────────────────┼───────┤
  │ Phase 2 │ Corp Profiling Pipeline │ 2일   │
  ├─────────┼─────────────────────────┼───────┤
  │ Phase 3 │ 조건부 쿼리 로직        │ 1일   │
  ├─────────┼─────────────────────────┼───────┤
  │ Phase 4 │ Evidence 연동           │ 1일   │
  ├─────────┼─────────────────────────┼───────┤
  │ Phase 5 │ API 엔드포인트          │ 0.5일 │
  ├─────────┼─────────────────────────┼───────┤
  │ Phase 6 │ 테스트 + QA             │ 1.5일 │
  ├─────────┼─────────────────────────┼───────┤
  │ Total   │                         │ 7일   │
  └─────────┴─────────────────────────┴───────┘
  ---
  Part 2: Senior Engineer 검토 의견

  🔧 Engineer Review

  동의 사항 ✅

  1. 2단계 파이프라인 구조: 프로파일링 → 조건부 쿼리 접근 방식 합리적
  2. TTL 캐싱: 7일 TTL로 API 비용 최적화 적절
  3. DB 스키마: rkyc_corp_profile + _latest 포인터 구조 기존 패턴과 일관됨

  이슈 제기 🚨
  ┌──────┬─────────────────────────────────┬────────┬───────────────────────────────────────────────┐
  │  ID  │              이슈               │ 심각도 │                     설명                      │
  ├──────┼─────────────────────────────────┼────────┼───────────────────────────────────────────────┤
  │ E-01 │ Perplexity 쿼리 5회 → 비용/시간 │ HIGH   │ 5개 쿼리 × 30초 = 150초. 파이프라인 병목      │
  ├──────┼─────────────────────────────────┼────────┼───────────────────────────────────────────────┤
  │ E-02 │ Profile 버전 관리 복잡도        │ MED    │ version 컬럼 필요한가? TTL만으로 충분         │
  ├──────┼─────────────────────────────────┼────────┼───────────────────────────────────────────────┤
  │ E-03 │ country_exposure 검증           │ MED    │ 합이 100% 초과 허용 시 데이터 품질 이슈       │
  ├──────┼─────────────────────────────────┼────────┼───────────────────────────────────────────────┤
  │ E-04 │ Graceful Degradation 미정의     │ HIGH   │ 프로파일 실패 시 기존 로직 fallback 상세 필요 │
  ├──────┼─────────────────────────────────┼────────┼───────────────────────────────────────────────┤
  │ E-05 │ evidence_type ENUM 추가         │ LOW    │ 기존 ENUM에 값 추가는 마이그레이션 주의       │
  └──────┴─────────────────────────────────┴────────┴───────────────────────────────────────────────┘
  변경 제안

  E-01 해결: 쿼리 통합

  # AS-IS: 5개 쿼리 개별 실행
  PROFILING_QUERIES = {
      "BASIC": "...",
      "FINANCIAL": "...",
      "EXPORT": "...",
      "SUPPLY": "...",
      "GLOBAL": "...",
  }

  # TO-BE: 단일 통합 쿼리
  UNIFIED_PROFILING_QUERY = """
  {corp_name} 기업 정보:
  1. 주요 사업 및 제품
  2. 매출 규모 및 재무 현황
  3. 수출 비중 및 주요 수출국
  4. 원자재 조달 및 공급망
  5. 해외 법인 및 공장

  {year}년 기준 최신 정보 검색
  """
  → 5회 → 1회로 감소, 30초 이내 완료

  E-02 해결: 버전 관리 단순화

  -- version 컬럼 제거, updated_at으로 히스토리 추적
  -- 필요 시 별도 history 테이블로 분리

  CREATE TABLE rkyc_corp_profile (
      profile_id UUID PRIMARY KEY,
      corp_id VARCHAR(20) NOT NULL UNIQUE,  -- 1:1 관계로 단순화
      ...
      updated_at TIMESTAMPTZ DEFAULT NOW()
  );

  -- latest 테이블 불필요 (1:1이므로)

  E-04 해결: Fallback 정의

  class CorpProfilingPipeline:
      def execute(self, corp_id, corp_name, industry_code):
          try:
              profile = self._fetch_and_structure(corp_name)
              if profile.confidence == "LOW" or not profile.business_summary:
                  raise InsufficientProfileError()
              return profile
          except (PerplexityError, InsufficientProfileError):
              # Fallback: 업종 기반 기본 프로파일 생성
              return self._generate_industry_default_profile(industry_code)

      def _generate_industry_default_profile(self, industry_code):
          """업종 마스터 기반 기본 프로파일"""
          industry = get_industry_master(industry_code)
          return CorpProfile(
              business_summary=f"{industry.industry_name} 업체",
              profile_confidence="LOW",
              country_exposure={},  # 빈 값
              source_urls=[],
              is_fallback=True,  # 플래그 추가
          )

  ---
  Part 3: QA Lead 검토 의견

  🧪 QA Review

  테스트 가능성 ✅

  1. Unit Test: Profile 파싱 로직 테스트 가능
  2. Integration Test: Perplexity Mock으로 E2E 테스트 가능
  3. DB Test: 스키마 마이그레이션 테스트 가능

  이슈 제기 🚨
  ┌──────┬──────────────────────────────┬────────┬───────────────────────────────────────────────────────┐      
  │  ID  │             이슈             │ 심각도 │                         설명                          │      
  ├──────┼──────────────────────────────┼────────┼───────────────────────────────────────────────────────┤      
  │ Q-01 │ Profile confidence 기준 모호 │ HIGH   │ HIGH/MED/LOW 판단 기준 명확히 정의 필요               │      
  ├──────┼──────────────────────────────┼────────┼───────────────────────────────────────────────────────┤      
  │ Q-02 │ 테스트 데이터 부재           │ MED    │ 6개 기업 중 실제 기업 2개만 Perplexity 결과 예측 가능 │      
  ├──────┼──────────────────────────────┼────────┼───────────────────────────────────────────────────────┤      
  │ Q-03 │ Edge case 미정의             │ HIGH   │ 기업명 동명이인, 검색 결과 0건 등                     │      
  ├──────┼──────────────────────────────┼────────┼───────────────────────────────────────────────────────┤      
  │ Q-04 │ 데이터 검증 규칙             │ MED    │ export_ratio_pct 범위, revenue_krw 단위 등            │      
  ├──────┼──────────────────────────────┼────────┼───────────────────────────────────────────────────────┤      
  │ Q-05 │ Regression 테스트            │ LOW    │ 기존 ENVIRONMENT 시그널 생성 로직 영향 확인 필요      │      
  └──────┴──────────────────────────────┴────────┴───────────────────────────────────────────────────────┘      
  테스트 케이스 제안

  Q-01 해결: Confidence 기준 명확화
  ┌────────────┬───────────────────────────────────────────┐
  │ Confidence │                   조건                    │
  ├────────────┼───────────────────────────────────────────┤
  │ HIGH       │ 공시(DART), IR 자료, 사업보고서 기반 정보 │
  ├────────────┼───────────────────────────────────────────┤
  │ MED        │ 뉴스, 언론 보도 기반 정보                 │
  ├────────────┼───────────────────────────────────────────┤
  │ LOW        │ 추정, 간접 정보, 출처 불명확              │
  └────────────┴───────────────────────────────────────────┘
  def _determine_confidence(self, sources: list[str]) -> str:
      official_keywords = ["dart", "ir", "사업보고서", "공시", "annual report"]
      news_keywords = ["뉴스", "news", "기사", "보도"]

      for url in sources:
          if any(k in url.lower() for k in official_keywords):
              return "HIGH"

      for url in sources:
          if any(k in url.lower() for k in news_keywords):
              return "MED"

      return "LOW"

  Q-03 해결: Edge Case 정의
  ┌────────────────┬──────────────────────────────────────────────┐
  │      Case      │                  처리 방법                   │
  ├────────────────┼──────────────────────────────────────────────┤
  │ 검색 결과 0건  │ Fallback (업종 기본 프로파일)                │
  ├────────────────┼──────────────────────────────────────────────┤
  │ 동명이인 기업  │ industry_code로 필터링 힌트 추가             │
  ├────────────────┼──────────────────────────────────────────────┤
  │ 외국 기업 동명 │ 한국 기업 명시 ("한국", "Korea" 키워드)      │
  ├────────────────┼──────────────────────────────────────────────┤
  │ 폐업/합병 기업 │ Profile에 status 필드 추가 (ACTIVE/INACTIVE) │
  └────────────────┴──────────────────────────────────────────────┘
  Q-04 해결: 데이터 검증 규칙

  class CorpProfileValidator:
      @staticmethod
      def validate(profile: dict) -> tuple[bool, list[str]]:
          errors = []

          # export_ratio_pct: 0-100
          if profile.get("export_ratio_pct"):
              if not (0 <= profile["export_ratio_pct"] <= 100):
                  errors.append("export_ratio_pct must be 0-100")

          # revenue_krw: 양수, 조 단위 이하
          if profile.get("revenue_krw"):
              if profile["revenue_krw"] < 0:
                  errors.append("revenue_krw must be positive")
              if profile["revenue_krw"] > 1_000_000_000_000_000:  # 1000조 이상 비정상
                  errors.append("revenue_krw seems unrealistic")

          # country_exposure: 값이 0-100
          for country, pct in profile.get("country_exposure", {}).items():
              if not (0 <= pct <= 100):
                  errors.append(f"country_exposure[{country}] must be 0-100")

          return len(errors) == 0, errors

  ---
  Part 4: 합의 과정 및 최종 결정

  📋 검토 회의록

  참석자

  - PM (Product Manager)
  - SE (Senior Engineer)
  - QA (QA Lead)

  논의 항목

  1. Perplexity 쿼리 횟수 (E-01)
  ┌──────┬───────────────────────────────────────────┐
  │ 역할 │                   의견                    │
  ├──────┼───────────────────────────────────────────┤
  │ PM   │ 5개 쿼리로 정확한 정보 수집 원함          │
  ├──────┼───────────────────────────────────────────┤
  │ SE   │ 5회 × 30초 = 150초 병목. 단일 쿼리 제안   │
  ├──────┼───────────────────────────────────────────┤
  │ QA   │ 단일 쿼리 시 정보 누락 가능성 테스트 필요 │
  └──────┴───────────────────────────────────────────┘
  합의:
  - 1차: 통합 쿼리 1회 실행
  - 2차: 특정 필드(export, overseas) 누락 시 보조 쿼리 1회 추가
  - 최대 2회로 제한

  def _fetch_profile(self, corp_name):
      # 1차: 통합 쿼리
      result = self._unified_search(corp_name)
      profile = self._extract_profile(result)

      # 2차: 핵심 필드 누락 시 보조 쿼리
      if profile.export_ratio_pct is None and profile.overseas_operations is None:
          supplementary = self._supplementary_search(corp_name)
          profile = self._merge_profiles(profile, supplementary)

      return profile

  2. 버전 관리 (E-02)
  ┌──────┬────────────────────────────────────────┐
  │ 역할 │                  의견                  │
  ├──────┼────────────────────────────────────────┤
  │ PM   │ 프로파일 변경 이력 추적 필요할 수 있음 │
  ├──────┼────────────────────────────────────────┤
  │ SE   │ MVP에서는 오버엔지니어링. 단순화 제안  │
  ├──────┼────────────────────────────────────────┤
  │ QA   │ 히스토리 필요 시 나중에 추가 가능      │
  └──────┴────────────────────────────────────────┘
  합의:
  - MVP: 버전 관리 제거, 1:1 관계로 단순화
  - Phase 2: 필요 시 rkyc_corp_profile_history 테이블 추가

  3. Confidence 기준 (Q-01)
  ┌──────┬─────────────────────────────────────┐
  │ 역할 │                의견                 │
  ├──────┼─────────────────────────────────────┤
  │ PM   │ 사용자에게 신뢰도 표시 필요         │
  ├──────┼─────────────────────────────────────┤
  │ SE   │ 자동 판단 어려움, LLM에게 위임 제안 │
  ├──────┼─────────────────────────────────────┤
  │ QA   │ 규칙 기반 + LLM 혼합 제안           │
  └──────┴─────────────────────────────────────┘
  합의:
  - LLM 프롬프트에 confidence 판단 기준 명시
  - 출처 URL 기반 보조 검증 (공시 URL → HIGH 보정)

  PROFILE_PROMPT_ADDITION = """
  ## Confidence 판단 기준
  - HIGH: DART 공시, IR 자료, 사업보고서 등 공식 출처 기반
  - MED: 뉴스, 언론 보도, 업계 리포트 기반
  - LOW: 추정, 간접 정보, 출처 불명확

  출처 URL을 기준으로 판단하세요.
  """

  4. Fallback 전략 (E-04)
  ┌──────┬─────────────────────────────────────────┐
  │ 역할 │                  의견                   │
  ├──────┼─────────────────────────────────────────┤
  │ PM   │ 프로파일 실패해도 시그널 생성은 해야 함 │
  ├──────┼─────────────────────────────────────────┤
  │ SE   │ 업종 기본 프로파일로 fallback           │
  ├──────┼─────────────────────────────────────────┤
  │ QA   │ Fallback 시그널에 플래그 필요           │
  └──────┴─────────────────────────────────────────┘
  합의:
  - Fallback 프로파일 생성 (업종 마스터 기반)
  - is_fallback: true 플래그 추가
  - Fallback 시그널의 confidence = LOW 고정

  5. Edge Case (Q-03)
  ┌───────────────┬─────────────────────────────────────────┐
  │     Case      │               합의된 처리               │
  ├───────────────┼─────────────────────────────────────────┤
  │ 검색 결과 0건 │ Fallback + search_failed: true          │
  ├───────────────┼─────────────────────────────────────────┤
  │ 동명이인      │ 쿼리에 {industry_name} 힌트 추가        │
  ├───────────────┼─────────────────────────────────────────┤
  │ 폐업 기업     │ status: INACTIVE 저장, 시그널 생성 스킵 │
  └───────────────┴─────────────────────────────────────────┘
  ---
  📊 리스크 및 이슈 요약

  Senior Engineer가 제기한 리스크
  ┌──────┬───────────────────────┬────────┬──────────────────────────────┐
  │  ID  │        리스크         │ 심각도 │          해결 상태           │
  ├──────┼───────────────────────┼────────┼──────────────────────────────┤
  │ E-01 │ API 호출 병목 (5회)   │ HIGH   │ ✅ 해결 (최대 2회로 제한)    │
  ├──────┼───────────────────────┼────────┼──────────────────────────────┤
  │ E-02 │ 버전 관리 복잡도      │ MED    │ ✅ 해결 (제거, 단순화)       │
  ├──────┼───────────────────────┼────────┼──────────────────────────────┤
  │ E-03 │ country_exposure 검증 │ MED    │ ✅ 해결 (0-100 범위 검증)    │
  ├──────┼───────────────────────┼────────┼──────────────────────────────┤
  │ E-04 │ Fallback 미정의       │ HIGH   │ ✅ 해결 (업종 기본 프로파일) │
  ├──────┼───────────────────────┼────────┼──────────────────────────────┤
  │ E-05 │ ENUM 마이그레이션     │ LOW    │ ⚠️ 주의 (ALTER TYPE 신중히)  │
  └──────┴───────────────────────┴────────┴──────────────────────────────┘
  QA가 제기한 리스크
  ┌──────┬──────────────────────┬────────┬───────────────────────────────┐
  │  ID  │        리스크        │ 심각도 │           해결 상태           │
  ├──────┼──────────────────────┼────────┼───────────────────────────────┤
  │ Q-01 │ Confidence 기준 모호 │ HIGH   │ ✅ 해결 (기준 명확화)         │
  ├──────┼──────────────────────┼────────┼───────────────────────────────┤
  │ Q-02 │ 테스트 데이터 부재   │ MED    │ ⚠️ 진행 중 (Mock 데이터 준비) │
  ├──────┼──────────────────────┼────────┼───────────────────────────────┤
  │ Q-03 │ Edge case 미정의     │ HIGH   │ ✅ 해결 (5개 케이스 정의)     │
  ├──────┼──────────────────────┼────────┼───────────────────────────────┤
  │ Q-04 │ 데이터 검증 규칙     │ MED    │ ✅ 해결 (Validator 추가)      │
  ├──────┼──────────────────────┼────────┼───────────────────────────────┤
  │ Q-05 │ Regression 테스트    │ LOW    │ ⚠️ Phase 6에서 수행           │
  └──────┴──────────────────────┴────────┴───────────────────────────────┘
  ---
  Part 5: 최종 PRD (합의 반영)

  Final PRD Summary

  주요 변경사항 (검토 후)
  ┌─────────────────┬──────────────┬────────────────────────┐
  │      항목       │     초안     │          최종          │
  ├─────────────────┼──────────────┼────────────────────────┤
  │ Perplexity 쿼리 │ 5회          │ 최대 2회 (통합 + 보조) │
  ├─────────────────┼──────────────┼────────────────────────┤
  │ DB 구조         │ version 관리 │ 1:1 단순 구조          │
  ├─────────────────┼──────────────┼────────────────────────┤
  │ Fallback        │ 미정의       │ 업종 기본 프로파일     │
  ├─────────────────┼──────────────┼────────────────────────┤
  │ Confidence      │ LLM 판단     │ LLM + URL 기반 보정    │
  ├─────────────────┼──────────────┼────────────────────────┤
  │ 검증            │ 미정의       │ CorpProfileValidator   │
  └─────────────────┴──────────────┴────────────────────────┘
  최종 데이터베이스 스키마

  -- v7 마이그레이션: Corp Profile
  CREATE TABLE rkyc_corp_profile (
      profile_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      corp_id VARCHAR(20) NOT NULL UNIQUE REFERENCES corp(corp_id),

      -- 비즈니스 정보
      business_summary TEXT NOT NULL,
      revenue_krw BIGINT,
      export_ratio_pct INTEGER CHECK (export_ratio_pct >= 0 AND export_ratio_pct <= 100),

      -- 노출도 정보
      country_exposure JSONB DEFAULT '{}',
      key_materials TEXT[] DEFAULT '{}',
      key_customers TEXT[] DEFAULT '{}',
      overseas_operations TEXT[] DEFAULT '{}',

      -- 메타데이터
      profile_confidence confidence_level NOT NULL,
      source_urls TEXT[] NOT NULL,
      raw_search_result JSONB,

      -- Fallback 플래그
      is_fallback BOOLEAN DEFAULT FALSE,
      search_failed BOOLEAN DEFAULT FALSE,

      -- 상태
      status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (status IN ('ACTIVE', 'INACTIVE', 'UNKNOWN')),

      -- TTL 관리
      fetched_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      expires_at TIMESTAMPTZ NOT NULL,

      created_at TIMESTAMPTZ DEFAULT NOW(),
      updated_at TIMESTAMPTZ DEFAULT NOW()
  );

  -- 인덱스
  CREATE INDEX idx_profile_corp ON rkyc_corp_profile(corp_id);
  CREATE INDEX idx_profile_expires ON rkyc_corp_profile(expires_at);
  CREATE INDEX idx_profile_confidence ON rkyc_corp_profile(profile_confidence);

  -- Evidence 타입 추가
  ALTER TYPE evidence_type_enum ADD VALUE IF NOT EXISTS 'CORP_PROFILE';
  ALTER TYPE ref_type_enum ADD VALUE IF NOT EXISTS 'PROFILE_KEYPATH';

  최종 파이프라인 흐름

  ┌─────────────────────────────────────────────────────────────────────┐
  │  Input: corp_id, corp_name, industry_code                           │
  └─────────────────────────┬───────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 0: Profile Cache Check                                        │
  │  - DB에서 기존 Profile 조회                                          │
  │  - TTL 유효 → 캐시 히트, Step 1 스킵                                  │
  │  - TTL 만료 또는 없음 → Step 1 진행                                   │
  └─────────────────────────┬───────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 1: Corp Profiling (Perplexity)                                │
  │                                                                     │
  │  1차 쿼리: "{corp_name} {industry_name} 기업 개요 매출 수출 공급망"    │
  │                                                                     │
  │  → LLM 구조화 → Profile JSON                                        │
  │                                                                     │
  │  IF export_ratio_pct IS NULL AND overseas_operations IS EMPTY:      │
  │    2차 쿼리: "{corp_name} 수출 비중 해외 법인"                        │
  │    → Profile 병합                                                   │
  │                                                                     │
  │  EXCEPTION:                                                         │
  │    → Fallback Profile (업종 기본)                                    │
  │    → is_fallback = TRUE                                             │
  └─────────────────────────┬───────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 2: Profile Validation & Storage                               │
  │                                                                     │
  │  - CorpProfileValidator.validate()                                  │
  │  - Confidence 보정 (URL 기반)                                        │
  │  - DB 저장 (rkyc_corp_profile)                                      │
  └─────────────────────────┬───────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 3: 조건부 ENVIRONMENT 쿼리 선택                                │
  │                                                                     │
  │  ┌─────────────────┬────────────────────────────────────────┐       │
  │  │ 조건            │ 활성화 카테고리                         │       │
  │  ├─────────────────┼────────────────────────────────────────┤       │
  │  │ export >= 30%   │ FX_RISK, TRADE_BLOC                    │       │
  │  │ "중국" in 노출   │ GEOPOLITICAL, SUPPLY_CHAIN, REGULATION │       │
  │  │ "미국" in 노출   │ GEOPOLITICAL, REGULATION, TRADE_BLOC   │       │
  │  │ materials 존재  │ COMMODITY, SUPPLY_CHAIN                │       │
  │  │ overseas 존재   │ GEOPOLITICAL, PANDEMIC, POLITICAL      │       │
  │  │ C26/C21        │ CYBER_TECH                              │       │
  │  │ D35            │ ENERGY_SECURITY                         │       │
  │  │ C10            │ FOOD_SECURITY                           │       │
  │  └─────────────────┴────────────────────────────────────────┘       │
  └─────────────────────────┬───────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 4: ENVIRONMENT 쿼리 실행 (기존 ExternalSearchPipeline)         │
  │                                                                     │
  │  - 선택된 카테고리의 쿼리만 실행                                       │
  │  - Profile 정보를 쿼리에 바인딩                                       │
  │    예: "미중 무역분쟁 {industry_name} 영향" +                         │
  │        "이 기업은 중국 매출 20%, 실리콘웨이퍼 의존"                     │
  └─────────────────────────┬───────────────────────────────────────────┘
                            │
                            ▼
  ┌─────────────────────────────────────────────────────────────────────┐
  │  Step 5: Signal 생성 + Evidence 연결                                │
  │                                                                     │
  │  - Signal 생성                                                      │
  │  - Evidence 추가:                                                   │
  │    - evidence_type: CORP_PROFILE                                    │
  │    - ref_type: PROFILE_KEYPATH                                      │
  │    - ref_value: /export_ratio_pct, /country_exposure/중국           │
  │    - snippet: "수출 비중 60%, 중국 매출 20%"                          │
  └─────────────────────────────────────────────────────────────────────┘

  최종 일정
  ┌───────┬────────────────────────────┬───────┬──────┐
  │ Phase │            항목            │ 기간  │ 담당 │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 1     │ DB 스키마 마이그레이션     │ 0.5일 │ SE   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 2     │ CorpProfilingPipeline 구현 │ 1.5일 │ SE   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 3     │ ProfileValidator 구현      │ 0.5일 │ SE   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 4     │ 조건부 쿼리 로직           │ 1일   │ SE   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 5     │ Evidence 연동              │ 0.5일 │ SE   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 6     │ API 엔드포인트             │ 0.5일 │ SE   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 7     │ Unit Test                  │ 1일   │ QA   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 8     │ Integration Test           │ 1일   │ QA   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ 9     │ Regression Test            │ 0.5일 │ QA   │
  ├───────┼────────────────────────────┼───────┼──────┤
  │ Total │                            │ 7일   │      │
  └───────┴────────────────────────────┴───────┴──────┘
  ---
  📝 최종 승인
  ┌─────────────────┬──────┬──────┬───────────────────────────┐
  │      역할       │ 이름 │ 승인 │           비고            │
  ├─────────────────┼──────┼──────┼───────────────────────────┤
  │ PM              │ -    │ ✅   │ PRD 작성 완료             │
  ├─────────────────┼──────┼──────┼───────────────────────────┤
  │ Senior Engineer │ -    │ ✅   │ 기술 검토 완료, 구현 가능 │
  ├─────────────────┼──────┼──────┼───────────────────────────┤
  │ QA Lead         │ -    │ ✅   │ 테스트 케이스 정의 완료   │
  └─────────────────┴──────┴──────┴───────────────────────────┘
  ---
  문서 끝